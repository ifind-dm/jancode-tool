# ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

ç«¶åˆJANã‚³ãƒ¼ãƒ‰æ¤œç´¢ãƒ„ãƒ¼ãƒ«ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã§ã™ã€‚

## ç›®æ¬¡

1. [ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ](#ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ)
2. [Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºè¨­å®š](#google-ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºè¨­å®š)
3. [Cloud Run ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤](#cloud-run-ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤)
4. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ

### 1. ç’°å¢ƒæ§‹ç¯‰

```bash
# venvä½œæˆ
python -m venv venv

# æœ‰åŠ¹åŒ–ï¼ˆMac/Linux/WSLï¼‰
source venv/bin/activate

# æœ‰åŠ¹åŒ–ï¼ˆWindows PowerShellï¼‰
venv\Scripts\Activate.ps1

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt
```

### 2. ç’°å¢ƒå¤‰æ•°è¨­å®š

`.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š

```env
# æ¥½å¤©APIï¼ˆå¿…é ˆï¼‰
RAKUTEN_APP_ID=ã‚ãªãŸã®ã‚¢ãƒ—ãƒªID

# ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
SPREADSHEET_AUTH_TYPE=oauth
SPREADSHEET_ID=ã‚ãªãŸã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
GOOGLE_CREDENTIALS_PATH=credentials.json
```

### 3. èµ·å‹•

```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:8000 ã«ã‚¢ã‚¯ã‚»ã‚¹

---

## Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºè¨­å®š

### èªè¨¼æ–¹å¼ã®é¸æŠ

| æ–¹å¼ | ç”¨é€” | è¨­å®š |
|------|------|------|
| **OAuth** | ãƒ†ã‚¹ãƒˆãƒ»å€‹äººåˆ©ç”¨ | åˆå›ãƒ–ãƒ©ã‚¦ã‚¶èªè¨¼ãŒå¿…è¦ |
| **ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ** | æœ¬ç•ªãƒ»ãƒãƒ¼ãƒ åˆ©ç”¨ | JSONã‚­ãƒ¼ã®ã¿ã§è‡ªå‹•èªè¨¼ |

---

### OAuth è¨­å®šï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰

#### Step 1: OAuth ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’ä½œæˆ

1. [Google Cloud Console](https://console.cloud.google.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠï¼ˆã¾ãŸã¯æ–°è¦ä½œæˆï¼‰
3. ã€ŒAPIã¨ã‚µãƒ¼ãƒ“ã‚¹ã€â†’ã€Œæœ‰åŠ¹ãªAPIã¨ã‚µãƒ¼ãƒ“ã‚¹ã€
4. ã€Œ+ APIã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’æœ‰åŠ¹åŒ–ã€â†’ã€ŒGoogle Sheets APIã€ã‚’æœ‰åŠ¹åŒ–
5. ã€Œèªè¨¼æƒ…å ±ã€â†’ã€Œ+ èªè¨¼æƒ…å ±ã‚’ä½œæˆã€â†’ã€ŒOAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€
6. åŒæ„ç”»é¢ã®è¨­å®šã‚’æ±‚ã‚ã‚‰ã‚ŒãŸã‚‰ï¼š
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¨®é¡: ã€Œå¤–éƒ¨ã€ã‚’é¸æŠ
   - ã‚¢ãƒ—ãƒªåã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›
   - ã‚¹ã‚³ãƒ¼ãƒ—ã¯è¿½åŠ ä¸è¦ï¼ˆå¾Œã§è‡ªå‹•è¨­å®šï¼‰
   - ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è‡ªåˆ†ã®Gmailã‚’è¿½åŠ 
7. OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã®ä½œæˆã«æˆ»ã‚‹ï¼š
   - ã‚¢ãƒ—ãƒªã®ç¨®é¡: **ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒª**
   - åå‰: ä»»æ„ï¼ˆä¾‹: jancode-toolï¼‰
8. ã€Œä½œæˆã€â†’ JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
9. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `credentials.json` ã¨ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ä¿å­˜

#### Step 2: ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š

`.env` ã«è¿½åŠ ï¼š

```env
SPREADSHEET_AUTH_TYPE=oauth
SPREADSHEET_ID=ã‚ãªãŸã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
GOOGLE_CREDENTIALS_PATH=credentials.json
```

> ğŸ’¡ **ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID** ã¯ URL ã® `https://docs.google.com/spreadsheets/d/ã€ã“ã“ã€‘/edit` ã®éƒ¨åˆ†

#### Step 3: æ¥ç¶šãƒ†ã‚¹ãƒˆ

```bash
python spreadsheet.py
```

åˆå›å®Ÿè¡Œæ™‚ï¼š
1. ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ã
2. Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
3. ã€Œã“ã®ã‚¢ãƒ—ãƒªã¯ç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“ã€â†’ã€Œè©³ç´°ã€â†’ã€Œã€‡ã€‡ã«ç§»å‹•ã€
4. ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯
5. `token.json` ãŒç”Ÿæˆã•ã‚Œã‚‹ï¼ˆä»¥é™ã¯è‡ªå‹•èªè¨¼ï¼‰

---

### ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šï¼ˆæœ¬ç•ªç”¨ï¼‰

#### Step 1: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ

1. [Google Cloud Console](https://console.cloud.google.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
3. ã€ŒIAMã¨ç®¡ç†ã€â†’ã€Œã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€
4. ã€Œ+ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã€
   - åå‰: ä»»æ„ï¼ˆä¾‹: jancode-spreadsheetï¼‰
   - èª¬æ˜: ä»»æ„
5. ã€Œä½œæˆã—ã¦ç¶šè¡Œã€â†’ ãƒ­ãƒ¼ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ— â†’ ã€Œå®Œäº†ã€
6. ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯
7. ã€Œéµã€ã‚¿ãƒ– â†’ã€Œéµã‚’è¿½åŠ ã€â†’ã€Œæ–°ã—ã„éµã‚’ä½œæˆã€â†’ JSON
8. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `credentials.json` ã¨ã—ã¦ä¿å­˜

#### Step 2: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å…±æœ‰

1. å¯¾è±¡ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
2. ã€Œå…±æœ‰ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ ï¼ˆ`xxx@xxx.iam.gserviceaccount.com`ï¼‰
4. æ¨©é™: **ç·¨é›†è€…**

> ğŸ’¡ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã¯ `credentials.json` å†…ã® `client_email` ã«è¨˜è¼‰

#### Step 3: ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š

`.env` ã‚’å¤‰æ›´ï¼š

```env
SPREADSHEET_AUTH_TYPE=service_account
SPREADSHEET_ID=ã‚ãªãŸã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
GOOGLE_CREDENTIALS_PATH=credentials.json
```

#### Step 4: æ¥ç¶šãƒ†ã‚¹ãƒˆ

```bash
python spreadsheet.py
```

---

## Cloud Run ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

### å‰ææ¡ä»¶

- Google Cloud SDK (`gcloud`) ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
- GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆæ¸ˆã¿
- æœ¬ç•ªç’°å¢ƒã§ã¯**ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼**ã‚’ä½¿ç”¨

### Step 1: gcloud ã«ãƒ­ã‚°ã‚¤ãƒ³

```bash
gcloud auth login
gcloud config set project ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
```

### Step 2: ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
gcloud run deploy jancode-tool \
  --source . \
  --region asia-northeast1 \
  --allow-unauthenticated \
  --set-env-vars "RAKUTEN_APP_ID=your_app_id,SPREADSHEET_AUTH_TYPE=service_account,SPREADSHEET_ID=your_spreadsheet_id"
```

### Step 3: èªè¨¼æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‰±ã„

Cloud Run ã§ã¯ `credentials.json` ã‚’ç›´æ¥å«ã‚ã‚‹ã‹ã€Secret Manager ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

#### æ–¹æ³•A: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚ã‚‹ï¼ˆç°¡æ˜“ï¼‰

`.dockerignore` ã‹ã‚‰ `credentials.json` ã‚’é™¤å¤–ã—ã¦ã€ãã®ã¾ã¾ãƒ‡ãƒ—ãƒ­ã‚¤ï¼š

```bash
# .dockerignore ã« credentials.json ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
gcloud run deploy jancode-tool --source . ...
```

#### æ–¹æ³•B: Secret Manager ã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰

```bash
# 1. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½œæˆ
gcloud secrets create google-credentials --data-file=credentials.json

# 2. Cloud Run ã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒã‚¦ãƒ³ãƒˆ
gcloud run deploy jancode-tool \
  --source . \
  --region asia-northeast1 \
  --allow-unauthenticated \
  --set-env-vars "RAKUTEN_APP_ID=xxx,SPREADSHEET_AUTH_TYPE=service_account,SPREADSHEET_ID=xxx,GOOGLE_CREDENTIALS_PATH=/secrets/credentials.json" \
  --set-secrets "/secrets/credentials.json=google-credentials:latest"
```

### ã‚³ãƒ¼ãƒ‰å¤‰æ›´å¾Œã®å†ãƒ‡ãƒ—ãƒ­ã‚¤

åŒã˜ã‚³ãƒãƒ³ãƒ‰ã‚’å†å®Ÿè¡Œï¼š

```bash
gcloud run deploy jancode-tool --source . --region asia-northeast1 --allow-unauthenticated
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### âŒ ã€Œã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€

- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒæ­£ã—ã„ã‹ç¢ºèª
- ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ãŒã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å…±æœ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### âŒ ã€Œèªè¨¼æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€

- `credentials.json` ãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹ã‹ç¢ºèª
- `.env` ã® `GOOGLE_CREDENTIALS_PATH` ãŒæ­£ã—ã„ã‹ç¢ºèª

### âŒ ã€Œã“ã®ã‚¢ãƒ—ãƒªã¯ç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“ã€ï¼ˆOAuthï¼‰

- æ­£å¸¸ã§ã™ã€‚ã€Œè©³ç´°ã€â†’ã€Œã€‡ã€‡ã«ç§»å‹•ã€ã§ç¶šè¡Œã—ã¦ãã ã•ã„
- æœ¬ç•ªå…¬é–‹ã™ã‚‹å ´åˆã¯Googleã®å¯©æŸ»ãŒå¿…è¦ã§ã™

### âŒ Cloud Run ã§èªè¨¼ã‚¨ãƒ©ãƒ¼

- Secret Manager ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã€Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã« Secret ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚‹ã‹ç¢ºèª
- ç’°å¢ƒå¤‰æ•° `GOOGLE_CREDENTIALS_PATH` ãŒã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ãƒ‘ã‚¹ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèª

---

## ç’°å¢ƒå¤‰æ•°ä¸€è¦§

| å¤‰æ•°å | å¿…é ˆ | èª¬æ˜ | ä¾‹ |
|--------|------|------|-----|
| `RAKUTEN_APP_ID` | âœ… | æ¥½å¤©APIã‚¢ãƒ—ãƒªID | `1234567890` |
| `SPREADSHEET_AUTH_TYPE` | - | èªè¨¼æ–¹å¼ | `oauth` or `service_account` |
| `SPREADSHEET_ID` | - | ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID | `1abc...xyz` |
| `GOOGLE_CREDENTIALS_PATH` | - | èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ | `credentials.json` |


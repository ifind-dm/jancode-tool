<!-- 検索完了メッセージ -->
<div class="bg-emerald-100 border border-emerald-300 rounded-xl p-4 mb-6 flex items-center gap-3 animate-pulse">
    <svg class="w-6 h-6 text-emerald-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span class="text-emerald-800 font-medium">検索完了！競合候補が {{ competitors|length }}件 見つかりました</span>
</div>

<!-- 入力した商品情報 -->
<div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-200 mb-6">
    <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        入力した商品
    </h3>
    
    <div class="flex gap-4">
        {% if product.image %}
        <img src="{{ product.image }}" alt="{{ product.name }}" class="w-24 h-24 object-contain rounded-lg bg-slate-100 flex-shrink-0">
        {% else %}
        <div class="w-24 h-24 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-8 h-8 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
        </div>
        {% endif %}
        
        <div class="flex-1 min-w-0">
            <h4 class="font-bold text-slate-800 text-lg leading-tight">{{ product.name }}</h4>
            <p class="text-slate-500 text-sm mt-1">ショップ: {{ product.shopName }}</p>
            <div class="flex items-center gap-3 mt-2">
                <span class="text-rakuten font-bold text-xl">¥{{ "{:,}".format(product.price) }}</span>
                <a href="{{ product.url }}" target="_blank" class="text-blue-500 hover:underline text-sm">
                    楽天で見る →
                </a>
            </div>
            {% if product.jan %}
            <p class="text-emerald-600 font-mono text-sm bg-emerald-50 inline-block px-2 py-0.5 rounded mt-1">
                JAN: {{ product.jan }}
                {% if product.janSource %}
                <span class="text-emerald-500 text-xs ml-1">({{ product.janSource }})</span>
                {% endif %}
            </p>
            {% endif %}
        </div>
    </div>
</div>

<!-- 競合候補一覧 -->
<div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-200">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-slate-700 flex items-center gap-2">
            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            競合候補
            <span class="text-sm font-normal text-slate-500">
                ({% if price_mode_label %}{{ price_mode_label }}: {% endif %}¥{{ "{:,}".format(price_min) }} 〜 ¥{{ "{:,}".format(price_max) }})
            </span>
        </h3>
        <span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-sm font-medium">
            {{ competitors|length }}件
        </span>
    </div>
    
    {% if competitors %}
    <form action="/export" method="post">
        <!-- 一括選択ボタン -->
        <div class="flex gap-2 mb-4">
            <button type="button" onclick="selectAllWithJan()" class="text-sm px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                JANありを全選択
            </button>
            <button type="button" onclick="deselectAll()" class="text-sm px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                選択解除
            </button>
        </div>
        
        <div class="space-y-3 mb-6 max-h-[600px] overflow-y-auto">
            {% for item in competitors %}
            <label class="flex gap-4 p-4 border border-slate-200 rounded-xl hover:border-rakuten hover:bg-red-50 transition-colors cursor-pointer group">
                <input 
                    type="checkbox" 
                    name="selected" 
                    value="{{ item.jan }}|{{ item.name }}|{{ item.shop }}|{{ item.price }}|{{ item.url }}"
                    data-has-jan="{{ 'true' if item.jan else 'false' }}"
                    class="w-5 h-5 mt-1 accent-rakuten flex-shrink-0"
                    onchange="updateCounter()"
                >
                
                {% if item.image %}
                <img src="{{ item.image }}" alt="{{ item.name }}" class="w-20 h-20 object-contain rounded-lg bg-slate-100 flex-shrink-0">
                {% else %}
                <div class="w-20 h-20 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg class="w-6 h-6 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                </div>
                {% endif %}
                
                <div class="flex-1 min-w-0">
                    <h4 class="font-medium text-slate-800 leading-tight group-hover:text-rakuten transition-colors">{{ item.name }}</h4>
                    <p class="text-slate-500 text-sm mt-1">{{ item.shop }}</p>
                    
                    {% if item.jan %}
                    <p class="text-emerald-600 font-mono text-sm mt-1 bg-emerald-50 inline-block px-2 py-0.5 rounded">
                        JAN: {{ item.jan }}
                        {% if item.janSource %}
                        <span class="text-emerald-500 text-xs ml-1">({{ item.janSource }})</span>
                        {% endif %}
                    </p>
                    {% else %}
                    <p class="text-slate-400 text-sm mt-1">JANコードなし</p>
                    {% endif %}
                    
                    <div class="flex items-center gap-3 mt-2">
                        <span class="text-rakuten font-bold text-lg">¥{{ "{:,}".format(item.price) }}</span>
                        <a href="{{ item.url }}" target="_blank" class="text-blue-500 hover:underline text-sm" onclick="event.stopPropagation()">
                            楽天で見る →
                        </a>
                    </div>
                </div>
            </label>
            {% endfor %}
        </div>
        
        <!-- エクスポートバー -->
        <div class="sticky bottom-4 bg-slate-800 text-white rounded-xl p-4 flex items-center justify-between shadow-lg">
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                <span>選択中: <span id="selectedCount" class="font-bold">0</span>件</span>
            </div>
            <button 
                type="submit"
                class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg transition-colors flex items-center gap-2"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                CSVエクスポート
            </button>
        </div>
    </form>
    
    <script>
        function updateCounter() {
            const checkboxes = document.querySelectorAll('input[name="selected"]:checked');
            document.getElementById('selectedCount').textContent = checkboxes.length;
        }
        
        function selectAllWithJan() {
            const checkboxes = document.querySelectorAll('input[name="selected"][data-has-jan="true"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateCounter();
        }
        
        function deselectAll() {
            const checkboxes = document.querySelectorAll('input[name="selected"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateCounter();
        }
    </script>
    {% else %}
    <div class="text-center py-12 text-slate-500">
        <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p class="text-lg font-medium">競合候補が見つかりませんでした</p>
        <p class="text-sm mt-1">同カテゴリ・価格帯の商品がありません</p>
    </div>
    {% endif %}
</div>

<!-- トップに戻るボタン -->
<div class="text-center mt-6">
    <a href="/" class="inline-flex items-center gap-2 text-slate-600 hover:text-rakuten transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        別の商品を検索
    </a>
</div>
